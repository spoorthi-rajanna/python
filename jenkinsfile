pipeline {
    agent any
    stages {
        stage('Build') {

            steps {
                sh 'python -m py_compile app.py config.py fabfile.py forms.py models.py'
            }
        }
         /* stage('Test') { 

            steps {
                sh 'py.test --verbose --junit-xml test-reports/results.xml app.py config.py fabfile.py forms.py models.py' 
            }
            post {
                always {
                    junit 'test-reports/results.xml' 
                }
            }
        } */
        
         
          stage('Deliver') {

            steps {
                sh 'pyinstaller --onefile app.py'
            }
            post {
                success {
                    archiveArtifacts 'dist/app'
                }
            }
        } 


                 stage('nexus') {
            steps {
                echo 'uploading to nexus....'

nexusPublisher nexusInstanceId: '12345', nexusRepositoryId: 'nexus_test', packages: [[$class: 'MavenPackage', mavenAssetList: [[classifier: '', extension: '', filePath: 'build/app/PKG-00.pkg']], mavenCoordinate: [artifactId: '${JOB_NAME}', groupId: 'pythonApp', packaging: 'pkg', version: '1.0.${BUILD_NUMBER}']]]
            }

        } 
        
         stage('Deploy') {
            steps {
                sh """ 
                wget "http://3.9.43.71:8081/repository/nexus_test/pythonApp/TEST3/1.0.${BUILD_NUMBER}/TEST3-1.0.${BUILD_NUMBER}.pkg"
                ssh-keygen -R hostname
scp TEST3-1.0.29.pkg ansadmin@172.31.28.19:/home/ansadmin

                
                """
                sshPublisher(publishers: [sshPublisherDesc(configName: 'ansuble_server', transfers: [sshTransfer(cleanRemote: false, excludes: '', execCommand: '', execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: 'moDest', remoteDirectorySDF: false, removePrefix: '', sourceFiles: 'TEST3/build/app/* .pkg'), sshTransfer(cleanRemote: false, excludes: '', execCommand: 'ansible-playbook deploy.yml', execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: '', sourceFiles: '')], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])
}
        
        }
    }
}
